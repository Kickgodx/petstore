.common_telegram:
  stage: notify
  script:
    - |
      if [ -z ${ENV_FLAG} ]; then
      ENVIRONMENT=""
      TEST=""
      else
      ENVIRONMENT="<b>–û–∫—Ä—É–∂–µ–Ω–∏–µ:</b> "${TEST_ENVIRONMENT}""
      TEST="<b>–¢–µ—Å—Ç:</b> "${TEST_NAME}""
      fi

      if [ "${TEST_STATUS}" == "success" ]; then
      export NOTIFICATION_TEXT="
      ‚úÖüåµüéÑ   –¢–µ—Å—Ç—ã –ø—Ä–æ–π–¥–µ–Ω—ã —É—Å–ø–µ—à–Ω–æ   üå≥üå¥‚ôªÔ∏è

      <b>–ü—Ä–æ–µ–∫—Ç:</b> "${CI_PROJECT_NAME}"
      <b>–í–µ—Ç–∫–∞ —Ç–µ—Å—Ç–æ–≤:</b> "${CI_COMMIT_BRANCH}"
      <b>–î–∂–æ–±–∞:</b> "${TEST_JOB_NAME}"
      ${ENVIRONMENT}
      ${TEST}
      <b>Commit:</b> "${CI_COMMIT_MESSAGE}"
      
      "
      else
      export NOTIFICATION_TEXT="
      üß≤‚ù§Ô∏èüö©   –¢–µ—Å—Ç—ã –ø—Ä–æ–≤–∞–ª–∏–ª–∏—Å—å   ‚ùåüíØüìç

      <b>–ü—Ä–æ–µ–∫—Ç:</b> "${CI_PROJECT_NAME}"
      <b>–í–µ—Ç–∫–∞ —Ç–µ—Å—Ç–æ–≤:</b> "${CI_COMMIT_BRANCH}"
      <b>–î–∂–æ–±–∞:</b> "${TEST_JOB_NAME}"
      ${ENVIRONMENT}
      ${TEST}
      <b>Commit:</b> "${CI_COMMIT_MESSAGE}"
      
      "
      fi
      message='
      {
      "chat_id":"'${CHAT_ID_AUTOTESTS}'",
      "message_thread_id": "'${TG_CHAT_THREAD_ID}'",
      "parse_mode": "HTML",
      "disable_notification": "true",
      "text": "
      '"${NOTIFICATION_TEXT}"'
      ",
      "reply_markup": { "inline_keyboard": [ [ { "text": "–ü–µ—Ä–µ–π—Ç–∏ –∫ allure-report","callback_data": "1","url": "'${REPORT_LINK}'" } ],[ { "text": "–ü–µ—Ä–µ–π—Ç–∏ –≤ –ø–∞–π–ø–ª–∞–π–Ω","callback_data": "2","url": "'${PIPELINE_LINK}'" } ], [ { "text": "–õ–æ–≥ –æ—à–∏–±–æ–∫ –∑–∞–ø—Ä–æ—Å–æ–≤","callback_data": "3","url": "'${LOG_LINK}'" } ] ] }
      }'
      curl -s -X POST ${TELEGRAM_API_URL}/bot${TG_DEVOPS_BOT_TOKEN}/sendMessage \
        --header "Content-Type: application/json" \
        --data "$message"
  extends:
    - .notifications-common

all_notification_with_env:
  variables:
    ENV_FLAG: "TRUE"
  rules:
    - if: $CI_COMMIT_BRANCH == "master" && $CI_PIPELINE_SOURCE == "schedule" && $SCHEDULED_ALL == "TRUE"
      when: on_success
    - if: $CI_COMMIT_BRANCH == "dev" && $CI_PIPELINE_SOURCE == "schedule" && $SCHEDULED_ALL == "TRUE"
      when: on_success
    - when: manual
  needs:
    - run_tests
    - make_allure_report
  extends:
    - .common_telegram
